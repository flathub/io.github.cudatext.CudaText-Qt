app-id: io.github.cudatext.CudaText-Qt
runtime: org.kde.Platform
runtime-version: '6.8'
sdk: org.kde.Sdk
build-options:
  append-path: /app/lib/sdk/freepascal/bin
  env:
    PPC_CONFIG_PATH: /app/lib/sdk/freepascal/etc
    FPCDIR: /app/lib/sdk/freepascal/fpcsrc
    FPC_DIR: /app/lib/sdk/freepascal/fpcsrc
    LAZARUSDIR: /app/lib/sdk/freepascal/share/lazarus
cleanup-commands:
  - rm -rf /app/lib/sdk/freepascal
command: cudatext
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --filesystem=home
  - --device=dri
  - --share=ipc
  - --share=network
modules:

  - name: fpc
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://downloads.sourceforge.net/project/freepascal/Linux/3.2.2/fpc-3.2.2.x86_64-linux.tar
        sha256: 5adac308a5534b6a76446d8311fc340747cbb7edeaacfe6b651493ff3fe31e83
      - type: archive
        only-arches:
          - aarch64
        url: https://downloads.sourceforge.net/project/freepascal/Linux/3.2.2/fpc-3.2.2.aarch64-linux.tar
        sha256: b39470f9b6b5b82f50fc8680a5da37d2834f2129c65c24c5628a80894d565451
      - type: archive
        url: https://downloads.sourceforge.net/project/freepascal/Source/3.2.2/fpcbuild-3.2.2.tar.gz
        sha256: 85ef993043bb83f999e2212f1bca766eb71f6f973d362e2290475dbaaf50161f
      - type: patch
        options: ['-d', 'fpcsrc']
        path: fpc-3.2.0--glibc-2.34.patch
    buildsystem: simple
    build-options:
      env:
        - fpcver=3.2.2
        - PREFIX=/app/lib/sdk/freepascal
      arch:
        aarch64:
          env: [PPNAME=ppca64]
        x86_64:
          env: [PPNAME=ppcx64]
    build-commands:
      # install src
      - mkdir -p ${PREFIX} && cp -r fpcsrc ${PREFIX}/
      # tar x fpcpre
      - mkdir fpcpre
      - tar -xf binary.*.tar && tar -C fpcpre -xf base.*.tar.gz
      - rm *.tar.gz *.tar
      # compile self
      - make -C fpcsrc compiler_cycle PP=`pwd`/fpcpre/lib/fpc/${fpcver}/${PPNAME}
      # compile rtl with new pp
      - make -C fpcsrc rtl_clean rtl_smart PP=`pwd`/fpcsrc/compiler/${PPNAME}
      # compile others with new pp,rtl
      - make -C fpcsrc packages_smart utils_all PP=`pwd`/fpcsrc/compiler/${PPNAME}
      # install
      - make -C fpcsrc compiler_distinstall rtl_distinstall packages_distinstall utils_distinstall
        INSTALL_PREFIX=${PREFIX}
        PP=`pwd`/fpcsrc/compiler/${PPNAME}
        FPCMAKE=`pwd`/fpcsrc/utils/fpcm/bin/${FLATPAK_ARCH}-linux/fpcmake
      # make cfg, add lib path, and link ppc
      -  ${PREFIX}/lib/fpc/${fpcver}/samplecfg ${PREFIX}/lib/fpc/${fpcver} ${PREFIX}/etc
      -  echo '-Fl/app/lib' >> ${PREFIX}/etc/fpc.cfg
      -  ln -s ../lib/fpc/${fpcver}/${PPNAME} ${PREFIX}/bin/${PPNAME}
      # fix not found ppcaarch64
      -  ln -s ppca64 ${PREFIX}/bin/ppcaarch64

  - name: lazarus
    sources:
      - type: archive
        url: https://gitlab.com/freepascal.org/lazarus/lazarus/-/archive/lazarus_3_6/lazarus-lazarus_3_6.tar.gz
        sha256: 535c01c9f6dc00867753b2a4d4e08b12fc8939ed314b5179c8bcb19f7d836f35
    buildsystem: simple
    build-options:
      append-path: /app/lib/sdk/freepascal/bin
      env:
        - INSTALL_PREFIX=/app/lib/sdk/freepascal
    build-commands:
      - find . -type f -iname makefile.fpc -exec fpcmake -Tall '{}' ';'
      - make lazbuild OPT='-gl'
      - touch lazarus startlazarus
      - make install
      - sed -i -e "s#__LAZARUSDIR__#$LAZARUSDIR/#" -e "s#__FPCSRCDIR__#$FPCDIR/#" -e "s#/app/bin/fpc#$INSTALL_PREFIX/bin/fpc#"
        tools/install/linux/environmentoptions.xml
      - install -Dm644 -t $LAZARUSDIR tools/install/linux/environmentoptions.xml

  - name: qt6pas
    sources:
      - type: shell
        commands:
          - cp -r ${LAZARUSDIR}/lcl/interfaces/qt6/cbindings/. .
          - sed -e"s/target.path = .\+/target.path = '\/app\/lib'/" -i ./Qt6Pas.pro
    buildsystem: qmake

  - name: cudatext
    sources:
      - type: archive
        url: https://github.com/bgrabitmap/bgrabitmap/archive/refs/tags/v11.6.3.tar.gz
        sha256: b3e39190bd6807ad51693be168ddbf48ae0457055bdc248c6deada946a018a7d
        dest: src/bgrabitmap
      - type: archive
        url: https://github.com/Alexey-T/EncConv/archive/refs/tags/2023.04.16.tar.gz
        sha256: ff5577849b0146d8751f21192f0656cd3f35b0633fa3e7750e3841998f81836a
        dest: src/EncConv
      - type: archive
        url: https://github.com/Alexey-T/ATBinHex-Lazarus/archive/refs/tags/2024.09.01.tar.gz
        sha256: 7ad5995429072a56d9f9617e4f623c4bd61826a29342b80612bfb32e0157acaf
        dest: src/ATBinHex-Lazarus
      - type: archive
        url: https://github.com/Alexey-T/ATFlatControls/archive/refs/tags/2024.11.05.tar.gz
        sha256: 39269fd96457d1dc6906baff6dfea4be4dc7ad7aa106d7a72a52f8619252d9a1
        dest: src/ATFlatControls
      - type: archive
        url: https://github.com/Alexey-T/ATSynEdit/archive/refs/tags/2024.11.04.tar.gz
        sha256: 4299eaac1d124192bdd0defe24f87a8aa0671ee8bd36630f3ed1bd92bd789934
        dest: src/ATSynEdit
      - type: archive
        url: https://github.com/Alexey-T/ATSynEdit_Cmp/archive/refs/tags/2024.07.28.tar.gz
        sha256: 57c1289cb897d6f23ac74d8fd5354c98cd2c64ad327a34feec9ab85058dfe127
        dest: src/ATSynEdit_Cmp
      - type: archive
        url: https://github.com/Alexey-T/EControl/archive/refs/tags/2024.10.26.tar.gz
        sha256: fb27a634d90eefb16266deda2e0f990ce925eeb3fbf5479c296b1a78863bd735
        dest: src/EControl
      - type: archive
        url: https://github.com/Alexey-T/ATSynEdit_Ex/archive/refs/tags/2024.10.26.tar.gz
        sha256: 8ec75c8458c3508b4710e395fd7ed2f92fde9e37e5ec59322d576c921dd627e5
        dest: src/ATSynEdit_Ex
      - type: archive
        url: https://github.com/Alexey-T/Python-for-Lazarus/archive/refs/tags/2024.10.15.tar.gz
        sha256: 82364066b53a125cbd0183dce96a9d2f27288a04222b696b630a1e0bb3c92580
        dest: src/Python-for-Lazarus
      - type: archive
        url: https://github.com/Alexey-T/Emmet-Pascal/archive/refs/tags/2023.12.02.tar.gz
        sha256: 9f8967e651253fc7027e8bef4115a45e9fb3b1c85536d1bd390da9c4d8a2efe0
        dest: src/Emmet-Pascal
      - type: archive
        url: https://github.com/Alexey-T/CudaText/archive/refs/tags/1.219.0.2.tar.gz
        sha256: b93873ede87a938fd0f6df9fa7c93c158a9cc33f5b14ccbd233c6ffbbf13d5bb
        dest: src/CudaText
      - type: file
        path: io.github.cudatext.CudaText-Qt.appdata.xml
    buildsystem: simple
    build-options:
      arch:
        x86_64:
          env:
            PPC: ppcx64
        aarch64:
          env:
            PPC: ppca64
    build-commands:
      - lazbuild --ws=qt6 -q --compiler=$PPC --pcp=. --lazarusdir="$LAZARUSDIR" "./src/bgrabitmap/bgrabitmap/bgrabitmappack.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/EncConv/encconv/encconv_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/ATBinHex-Lazarus/atbinhex/atbinhex_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/ATFlatControls/atflatcontrols/atflatcontrols_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/ATSynEdit/atsynedit/atsynedit_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/ATSynEdit_Cmp/atsynedit_cmp/atsynedit_cmp_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/EControl/econtrol/econtrol_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/ATSynEdit_Ex/atsynedit_ex/atsynedit_ex_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/Python-for-Lazarus/python4lazarus/python4lazarus_package.lpk"
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/Emmet-Pascal/emmet/emmet_package.lpk"
      # Replace references to /usr/share/cudatext with correct path, prior to compiling CudaText
      - sed -i -e"s/\/usr\/share\/cudatext/\\$FLATPAK_DEST\/share\/cudatext/g" src/CudaText/app/proc_globdata.pas
      - lazbuild --ws=qt6 -q --pcp=. --lazarusdir="$LAZARUSDIR" "./src/CudaText/app/cudatext.lpi"
      - install -Dm755 src/CudaText/app/cudatext -t $FLATPAK_DEST/bin
      # Install all data and plugins
      - mkdir -p $FLATPAK_DEST/share/cudatext
      - cp -r src/CudaText/app/data $FLATPAK_DEST/share/cudatext/
      - cp -r src/CudaText/app/py $FLATPAK_DEST/share/cudatext/
      - cp -r src/CudaText/app/settings_default $FLATPAK_DEST/share/cudatext/
      # Desktop file and icon - desktop file needs to have the icon name corrected first
      - desktop-file-edit --set-key=Icon --set-value="io.github.cudatext.CudaText-Qt" src/CudaText/setup/debfiles/cudatext.desktop
      - install -D src/CudaText/setup/debfiles/cudatext.desktop $FLATPAK_DEST/share/applications/io.github.cudatext.CudaText-Qt.desktop
      - install -D src/CudaText/setup/debfiles/cudatext-512.png $FLATPAK_DEST/share/icons/hicolor/512x512/apps/io.github.cudatext.CudaText-Qt.png
      - install -D io.github.cudatext.CudaText-Qt.appdata.xml $FLATPAK_DEST/share/metainfo/io.github.cudatext.CudaText-Qt.metainfo.xml
